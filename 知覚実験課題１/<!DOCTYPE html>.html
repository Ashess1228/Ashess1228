<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アクセント型知覚実験</title>
    <!-- jsPsych core library -->
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/jspsych.js"></script>
    <!-- jsPsych styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/css/jspsych.css">
    <!-- jsPsych html button plugin -->
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
</head>
<body>
    <div id="jspsych-target"></div>

    <script>
        // 定義された録音ファイル
        var audioFiles = [
            '得る.wav', 
            '混む.wav',
            '行う.wav'
        ];

        // 調査文
        var sentences = [
            '彼女はその本を__ことができた。昨日、彼女はついにその本を__。',
            'この店はいつも__。昨日、この店は非常に__。',
            '彼女はイベントを__予定だ。昨日、彼女はイベントを__。'
        ];

        // 選択肢
        var choices = [
            ['得る①', '得る⓪'], 
            ['混む①', '混む⓪'],
            ['おこなう①', 'おこなう⓪', 'おこなう②', 'おこなう③']
        ];

        // 追加的な選択肢
        var extraChoices = [
            ['得た①', '得た⓪'],
            ['混んだ①', 'こんだ⓪'],
            ['おこなった①', 'おこなった⓪', 'おこなった②', 'おこなった③']
        ];

        var timeline = [];
        var replayCount = 0; // 记录「録音を再生」按钮的点击次数

        // 録音再生页面
        for (var i = 0; i < audioFiles.length; i++) {
            let count = 0; // 每个句子的「録音を再生」按钮点击次数
            let currentAudio = audioFiles[i]; // 保留当前音频文件路径

            // 録音再生页面
            var audioTrial = {
                type: 'html-button-response',
                stimulus: '<button class="jspsych-btn" id="play-button">録音を再生</button>' + 
                          '<p>' + sentences[i].replace(/__/g, '_____') + '</p>' +
                          '<button class="jspsych-btn" id="next-button">next</button>',
                choices: [], // 禁用自带的按钮
                on_load: function() {
                    var played = false;  // 防止重复播放
                    document.getElementById('play-button').addEventListener('click', function() {
                        if (!played) {
                            count++;  // 记录点击次数
                            var audio = new Audio(currentAudio); // 创建新的 Audio 对象
                            audio.play(); // 播放音频
                            console.log("Playing audio: " + currentAudio);
                            played = true; // 确保只播放一次
                            audio.onended = function() {
                                played = false; // 音频播放结束后可以再次播放
                            };
                        }
                    });

                    document.getElementById('next-button').addEventListener('click', function() {
                        jsPsych.finishTrial(); // 让 jsPsych 跳转到下一页
                    });
                },
                on_finish: function(data) {
                    data.replay_count = count;  // 保存点击次数
                }
            };
            timeline.push(audioTrial);

            // 選択肢页面
            var choiceTrial = {
                type: 'html-button-response',
                stimulus: '<button class="jspsych-btn" id="play-choice-button">録音を再生</button>' + 
                          '<p>どちらのアクセント型に聞こえますか？</p>',
                choices: choices[i],
                button_html: '<button class="jspsych-btn">%choice%</button>',
                on_load: function() {
                    document.getElementById('play-choice-button').addEventListener('click', function() {
                        var audio = new Audio(currentAudio);
                        audio.play();
                        console.log("Playing audio again: " + currentAudio);
                    });
                }
            };
            timeline.push(choiceTrial);

            // 追加的な選択肢页面
            var extraChoiceTrial = {
                type: 'html-button-response',
                stimulus: '<button class="jspsych-btn" id="play-extra-button">録音を再生</button>' + 
                          '<p>どちらのアクセント型に聞こえますか？</p>',
                choices: extraChoices[i],
                button_html: '<button class="jspsych-btn">%choice%</button>',
                on_load: function() {
                    document.getElementById('play-extra-button').addEventListener('click', function() {
                        var audio = new Audio(currentAudio);
                        audio.play();
                        console.log("Playing audio again: " + currentAudio);
                    });
                }
            };
            timeline.push(extraChoiceTrial);
        }

        // 実験終了ページ
        var endTrial = {
            type: 'html-button-response',
            stimulus: '実験終了です。ご参加いただきありがとうございました。',
            choices: jsPsych.NO_KEYS,
            trial_duration: 2000
        };
        timeline.push(endTrial);

        // 実験を開始し、結果をCSVとして出力
        jsPsych.init({
            timeline: timeline,
            preload_audio: audioFiles,
            on_finish: function() {
                // データをCSV形式でダウンロード
                var data = jsPsych.data.get().csv();
                var replayData = jsPsych.data.get().addToAll({ replay_count: replayCount }).csv(); // 包含「録音を再生」点击次数
                var blob = new Blob([replayData], { type: 'text/csv' });
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'accent_experiment_data_with_replay_count.csv';
                a.click();
            }
        });
    </script>
</body>
</html>
