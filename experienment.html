<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsPsych Perception Experiment</title>
    <!-- 引入 jsPsych 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/jspsych.js"></script>
    <!-- 引入 jsPsych 样式表 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/css/jspsych.css">
    <!-- 引入音频响应插件 -->
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-audio-button-response.js"></script>
    <!-- 引入键盘响应插件 -->
    <script src="https://cdn.jsdelivr.net/npm/jspsych@6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
</head>
<body>
    <div id="jspsych-target"></div> <!-- jsPsych实验显示位置 -->
    
    <script>
        // 定义音频文件的路径和命名
        var audioFiles = [
          { stimulus: 'fromManipulationEditor1.wav', choices: ['ママママ②', 'ママママ③'] },
          { stimulus: 'fromManipulationEditor2.wav', choices: ['ママママ②', 'ママママ③'] },
          { stimulus: 'fromManipulationEditor3.wav', choices: ['ママママ②', 'ママママ③'] },
          { stimulus: 'fromManipulationEditor4.wav', choices: ['ママママ②', 'ママママ③'] },
          { stimulus: 'fromManipulationEditor5.wav', choices: ['ママママ②', 'ママママ③'] },
          { stimulus: 'fromManipulationEditor6.wav', choices: ['ママママ②', 'ママママ③'] },
          { stimulus: 'fromManipulationEditor7.wav', choices: ['ママママ②', 'ママママ③'] },
          { stimulus: 'fromManipulationEditor8.wav', choices: ['ママママ②', 'ママママ③'] },
          { stimulus: 'fromManipulationEditor9.wav', choices: ['ママママ②', 'ママママ③'] }
        ];

        // 随机化音频文件顺序
        var randomizedAudioFiles = jsPsych.randomization.shuffle(audioFiles);

        var timeline = [];

        // 欢迎页面
        var welcome = {
          type: 'html-keyboard-response',
          stimulus: '実験へようこそ。スペースキーを押して始めてください。',
          choices: [' ']
        };
        timeline.push(welcome);

        // 为每个音频创建一个试次
        for (var i = 0; i < randomizedAudioFiles.length; i++) {
          var audioTrial = {
            type: 'audio-button-response',
            stimulus: randomizedAudioFiles[i].stimulus,
            choices: randomizedAudioFiles[i].choices,
            prompt: '<p>どっちのアクセント型に聞こえますか？</p>',
            button_html: '<button class="jspsych-btn">%choice%</button>',
            trial_ends_after_audio: false,
            response_ends_trial: true
          };
          timeline.push(audioTrial);
        }

        // 实验结束页面
        var end = {
          type: 'html-keyboard-response',
          stimulus: '実験終了です。ご参加いただきありがとうございました。',
          choices: jsPsych.NO_KEYS,
          trial_duration: 2000
        };
        timeline.push(end);

        // 初始化实验并预加载音频文件
        jsPsych.init({
          timeline: timeline,
          preload_audio: randomizedAudioFiles.map(a => a.stimulus),
          on_finish: function() {
            // 实验结束时导出数据为CSV格式
            var data_csv = jsPsych.data.get().csv();
            var blob = new Blob([data_csv], { type: 'text/csv' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'experiment_data.csv';
            a.click();
          }
        });
    </script>
</body>
</html>
